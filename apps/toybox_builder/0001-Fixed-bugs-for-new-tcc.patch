From 682d342e73d72ef220e24314be4adfb3f28849a8 Mon Sep 17 00:00:00 2001
From: Mateusz Stadnik <matgla@live.com>
Date: Sun, 8 Feb 2026 22:46:11 +0100
Subject: [PATCH] Fixed bugs for new tcc

---
 main.c                 | 2 +-
 scripts/make.sh        | 2 +-
 scripts/portability.sh | 2 +-
 toys/pending/sh.c      | 5 +++--
 toys/posix/echo.c      | 1 -
 5 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/main.c b/main.c
index aa6a52cb..8dc2426d 100644
--- a/main.c
+++ b/main.c
@@ -224,7 +224,7 @@ void toy_singleinit(struct toy_list *which, char *argv[])
 
     if (which->flags & TOYFLAG_LINEBUF) btype = _IOLBF;
     else if (which->flags & TOYFLAG_NOBUF) btype = _IONBF;
-    else buf = xmalloc(4096);
+    buf = xmalloc(4096);
     setvbuf(stdout, buf, btype, buf ? 4096 : 0);
   }
 }
diff --git a/scripts/make.sh b/scripts/make.sh
index c2e79c42..7da3bbf0 100755
--- a/scripts/make.sh
+++ b/scripts/make.sh
@@ -185,7 +185,7 @@ then
     # turn any non-quoted opstring (NULL or 0) into " " (because fscanf can't
     # handle "" with nothing in it, and mkflags uses that).
 
-    ) | ${CROSS_COMPILE}${CC} -E - | \
+    ) | ${CROSS_COMPILE}${CC} -E - | grep -v '__builtin_\|__asm__' | \
     $SED -n -e 's/" *"//g;/^#/d;t clear;:clear;s/"/"/p;t;s/\( [AB] \).*/\1 " "/p'
 
   # Sort resulting line pairs and glue them together into triplets of
diff --git a/scripts/portability.sh b/scripts/portability.sh
index 570d9e29..d5d6df3b 100644
--- a/scripts/portability.sh
+++ b/scripts/portability.sh
@@ -19,7 +19,7 @@ then
   CFLAGS+=" -Wno-deprecated-declarations"
   : ${LDOPTIMIZE:=-Wl,-dead_strip} ${STRIP:=strip}
 else
-  : ${LDOPTIMIZE:=-Wl,--gc-sections -Wl,--as-needed} ${STRIP:=strip -s -R .note* -R .comment}
+  : ${LDOPTIMIZE:=-Wl,--as-needed} ${STRIP:=strip -s -R .note* -R .comment}
 fi
 
 # Disable pointless warnings only clang produces
diff --git a/toys/pending/sh.c b/toys/pending/sh.c
index bebe7bd5..40d14f5d 100644
--- a/toys/pending/sh.c
+++ b/toys/pending/sh.c
@@ -508,7 +508,7 @@ static long get_lineno(struct sh_fcall **fff)
 {
   struct sh_fcall *ff;
 
-  for (ff = TT.ff; !ff->source || !ff->name; ff = ff->next);
+  for (ff = TT.ff; (!ff->source || !ff->name) && (ff->next != ff); ff = ff->next);
   if (fff) *fff = ff;
 
   return ff->pl ? ff->pl->lineno : ff->lineno;
@@ -3038,7 +3038,8 @@ if (DEBUG) { dprintf(2, "%d run command %p %s\n", getpid(), TT.ff, *pp->arg.v);
 // TODO: when to prioritize $PATH over MAYFORK?
     if (jj&(TOYFLAG_NOFORK|TOYFLAG_MAYFORK)) {
       sigjmp_buf rebound, *prebound = toys.rebound;
-      char temp[jj = offsetof(struct toy_context, rebound)];
+      jj = offsetof(struct toy_context, rebound);
+      char temp[256];
 
       // This fakes lots of what toybox_main() does.
       memcpy(&temp, &toys, jj);
diff --git a/toys/posix/echo.c b/toys/posix/echo.c
index 702efee6..53dac7d5 100644
--- a/toys/posix/echo.c
+++ b/toys/posix/echo.c
@@ -35,7 +35,6 @@ void echo_main(void)
 {
   int i = 0;
   char *arg, *c, out[8];
-
   while ((arg = toys.optargs[i])) {
     if (i++) putchar(' ');
 
-- 
2.53.0

